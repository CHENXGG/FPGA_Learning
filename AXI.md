视频学习：[【06 如何科学的设计FPGA：实现AXI总线自由之AXI解读】](https://www.bilibili.com/video/BV1mD4y1p7UK/?share_source=copy_web&vd_source=71eb29aa240f1a4840fd5e8323a96ee9)

博客记录：[AXI 总线详解](https://blog.csdn.net/weixin_49617016/article/details/108398026)、[AXI总线介绍](https://www.cnblogs.com/mikewolf2002/p/10322532.html)、[AXI协议规范超详细中文总结版](https://blog.csdn.net/HackEle/article/details/125775935)、[深入理解AMBA总线（十九）AXI4新增信号以及AXI4-lite](https://zhuanlan.zhihu.com/p/647325572)、[深入理解AMBA总线（十五）AXI-stream](https://zhuanlan.zhihu.com/p/642670753)、[AMBA协议AXI-Stream（协议信号、设计实践）](https://blog.csdn.net/PPRAM/article/details/129350338)

# AXI总线是什么

AXI是ARM公司推出的Advanced Microcontroller Bus Architecture（简称AMBA）总线定义的通信接口之一。

AMBA 3.0包含了四种不同的总线标准，分别是：

* AHB（Advanced High-performance Bus）
* ASB（Advanced System Bus）
* APB（Advanced Peripheral Bus）
* AXI（Advanced eXtensible Interface）

其中AXI是在AMBA 3.0的协议中增加的。AHB、APB总线在ARM架构的MCU中非常常见，**而AXI则在Xilinx的FPGA中被广泛使用，许多高速接口IP核使用AXI进行数据传输，Xilinx目前很火的ZYNQ中也使用AXI进行PL和PS的互联**。因此，学习AXI接口对于PFGA有重要的意义。

AXI总线可以细分为三类，分别为：

* AXI4：主要面向高性能地址映射通信的需求，是面向地址映射的接口，允许最大256轮的数据突发传输；

* AXI4-Lite：是一个轻量级的地址映射单次传输接口，占用很少的逻辑单元。

* AXI4-Stream：面向高速流数据传输；去掉了地址项，允许无限制的数据突发传输规模。

# AXI与AXI-LITE

AXI协议的主要特点有：

* 适合高带宽和低延迟的设计，不需要复杂的桥

-  单向通道体系结构
-  **分离的地址/控制和数据阶段，分离的读写数据通道**
-  支持突发传输，支持非对齐数据传输，支持乱序传输完成（PS：[突发传输](https://baike.sogou.com/v71658396.htm#!)是指在同一行中相邻的存储单元连续进行数据传输的方式）
-  向后兼容AHB与APB接口

AXI-LITE是精简版的AXI4 协议，取消了很多控制数据线。因为很多时候我们用不到那么多AXI 的特性，**==使用简化版本可以省面积省功耗==**。AXI4-lite一般用在寄存器配置或者是其它的一些简单外设上，该协议基本上是用来替代APB协议的。

AXI4-lite的特性如下：

- 所有的传输的Burst length为1，即不支持突发传输；(PS：所以一般用在寄存器配置)
- 没有SIZE信号、没有LAST信号；（PS：因为不支持突发传输）
- 由于AXI4-lite主要是用来配置寄存器，配置寄存器基本都希望立即生效，因此其是Non-bufferable和Non-modifiable的；（PS：暂时没关心）
- 不支持原子操作。（PS：暂时没关心）

## 通信模型

AXI是主从结构，一个典型的系统结构如下：

![image-20240906112838608](https://gitee.com/cxgxgg/typora_img/raw/master/img/202409061128736.png)

主机和从机之间通过AXI Interconnect实现AXI接口的相互连接。每一个从设备都需要进行地址划分，主机通过地址对从机进行访问。其中主机的写地址线为32位位宽，但其中高位宽实际是用于地址块划分，即对从设备进行使能访问。因此，在配置从设备的地址时(Address)时，设备地址不能重叠，且地址分配时需要整块分配。而AXI Interconnect可以认为是一个带仲裁功能的多路选择器，起到根据主机发送的地址对从机进行使能的作用。

## 5个通信通道

AXI总线有五个独立的通道：写地址通道**（AW）**、写数据通道**（W）**、写响应通道**（B）**、读地址通道**（AR）**、读数据通道**（R）**。5个通道及其工作时序的示意如下图所示。

![image-20240906135554156](https://gitee.com/cxgxgg/typora_img/raw/master/img/202409061355201.png)

![image-20240906135601009](https://gitee.com/cxgxgg/typora_img/raw/master/img/202409061356035.png)

### 全局信号

| 信号    | 源           | 描述                     |
| ------- | ------------ | ------------------------ |
| ACLK    | Clock source | 全局时钟信号             |
| ARESETn | Reset source | 全局复位信号，低电平有效 |

### 写地址通道信号

| 信号                 | 源           | 描述                                                         |
| -------------------- | ------------ | ------------------------------------------------------------ |
| AWID[3:0]            | 主机         | 写地址ID，这个信号是写地址信号组的ID tag。                   |
| ==**AWADDR[31:0]**== | ==**主机**== | ==**写地址。**==                                             |
| **==AWLEN[3:0]==**   | **==主机==** | **==突发式写的长度。此长度决定突发式写所传输的数据的个数。==** |
| **==AWSIZE[2:0]==**  | **==主机==** | **==突发式写的大小。==**                                     |
| AWBURST[1:0]         | 主机         |                                                              |
| AWLOCK[1:0]          | 主机         | 锁类型。                                                     |
| AWCACHE[3:0]         | 主机         | Cache类型。这信号指明事务的bufferable、cacheable、write-through、write-back、allocate attributes信息。 |
| AWPROT[2:0]          | 主机         | 保护类型。                                                   |
| ==**AWVALID**==      | ==**主机**== | ==**写地址有效。1 = 地址和控制信息有效0 = 地址和控制信息无效这个信号会一直保持，直到AWREADY变为高。**== |
| ==**AWREADY**==      | ==**设备**== | ==**写地址准备好。这个信号用来指明设备已经准备好接受地址和控制信息了。1 = 设备准备好0 = 设备没准备好**== |

### 写数据通道信号

| 信号                | 源           | 描述                                                         |
| ------------------- | ------------ | ------------------------------------------------------------ |
| WID[3:0]            | 主机         | 写ID tag，WID的值必须与AWID的值匹配                          |
| ==**WDATA[31:0]**== | ==**主机**== | ==**写的数据。**==                                           |
| WSTRB[3:0]          | 主机         | 写阀门。                                                     |
| ==**WLAST**==       | ==**主机**== | ==**写的最后一个数据。**==                                   |
| ==**WVALID**==      | ==**主机**== | ==**写有效1 = 写数据和阀门有效0 = 写数据和阀门无效**==       |
| ==**WREADY**==      | ==**设备**== | ==**写就绪。指明设备已经准备好接受数据了1 = 设备就绪0 = 设备未就绪**== |

### 写响应通道信号

| 信号           | 源           | 描述                                                         |
| -------------- | ------------ | ------------------------------------------------------------ |
| BID[3:0]       | 设备         | 响应ID ， 这个数值必须与AWID的数值匹配。                     |
| BRESP[1:0]     | 设备         | 写响应。这个信号指明写事务的状态。可能有的响应：OKAY、EXOKAY、SLVERR、DECERR。 |
| **==BVALID==** | **==设备==** | **==写响应有效。1 = 写响应有效0 = 写响应无效==**             |
| ==**BREADY**== | ==**主机**== | ==**接受响应就绪。该信号表示主机已经能够接受响应信息。1 = 主机就绪0 = 主机未就绪**== |

### 读地址通道信号

| 信号                 | 源           | 描述                                                         |
| -------------------- | ------------ | ------------------------------------------------------------ |
| ARID[3:0]            | 主机         | 读地址ID。                                                   |
| ==**ARADDR[31:0]**== | ==**主机**== | ==**读地址。**==                                             |
| ==**ARLEN[3:0]**==   | ==**主机**== | ==**突发式读长度。**==                                       |
| ==**ARSIZE[2:0]**==  | ==**主机**== | ==**突发式读大小。**==                                       |
| ==**ARBURST[1:0]**== | ==**主机**== | ==**突发式读类型，有FIXED、INCR 和WRAP三类。**==             |
| ARLOCK[1:0]          | 主机         | 锁类型。                                                     |
| ARCACHE[3:0]         | 主机         | Cache类型。                                                  |
| ARPROT[2:0]          | 主机         | 保护类型。                                                   |
| ==**ARVALID**==      | ==**主机**== | ==**读地址有效。信号一直保持，直到ARREADY为高。1 = 地址和控制信息有效0 = 地址和控制信息无效**== |
| ==**ARREADY**==      | ==**设备**== | ==**读地址就绪。指明设备已经准备好接受数据了。1 = 设备就绪0 = 设备未就绪**== |

### 读数据通道信号

| 信号                | 源           | 描述                                                         |
| ------------------- | ------------ | ------------------------------------------------------------ |
| RID[3:0]            | 设备         | 读ID tag。RID的数值必须与ARID的数值匹配。                    |
| ==**RDATA[31:0]**== | ==**设备**== | ==**读数据。**==                                             |
| RRESP[1:0]          | 设备         | 读响应。这个信号指明读传输的状态：OKAY、EXOKAY、SLVERR、DECERR。 |
| ==**RLAST**==       | ==**设备**== | ==**读事务传送的最后一个数据。**==                           |
| ==**RVALID**==      | ==**设备**== | ==**读数据有效。1 = 读数据有效。0 = 读数据无效。**==         |
| ==**RREADY**==      | ==**主机**== | ==**读数据就绪。1 = 主机就绪0 = 主机未就绪**==               |

AXI-LITE精简后的信号如图所示：

![image-20240906152545609](https://gitee.com/cxgxgg/typora_img/raw/master/img/202409061526377.png)

## 通信时序

### 握手协议

全部5个通道使用相同的VALID/READY握手机制传输数据及控制信息。**==传输源产生VLAID信号来指明何时数据或控制信息有效，而目地源产生READY信号来指明已经准备好接受数据或控制信息。==**传输发生在VALID和READY信号同时为高的时候，VALID和READY信号的有以下三种关系。

<img src="https://gitee.com/cxgxgg/typora_img/raw/master/img/202409061413654.png" alt="image-20240906140814098" style="zoom:50%;" />

<img src="https://gitee.com/cxgxgg/typora_img/raw/master/img/202409061413186.png" alt="image-20240906140942029" style="zoom:55%;" />

<img src="https://gitee.com/cxgxgg/typora_img/raw/master/img/202409061414534.png" alt="image-20240906140957308" style="zoom:45%;" />

### 写数据

一次写数据分为三个阶段：

1. 地址：在主机准备读地址（AWADDR[31:0]），并AWVALID主动置高以表明地址已有效后。在下一个时钟沿，从机会将AWREADY置高以表明地址已被接收。

2. 数据：在写数据时，主机会将WVALID持续置高以表示数据有效，从机会将数据读入，并将WREADY置高表示数据已经写入。当主机发送最后一个读数据后，会将WVALID同时置高以表明数据通信完毕。

3. 响应：从写数据开始，主机就将BREADY置高以等待响应。在写数据结束后，从机将BVALID置高以进行响应。

  ![clip_image002](https://gitee.com/cxgxgg/typora_img/raw/master/img/202409061433757.gif)

### 读数据

一次读数据分为两个阶段：

1. 地址：在主机准备读地址（ARADDR[31:0]），并ARVALID主动置高以表明地址已有效后。在下一个时钟沿，从机会将ARREADY置高以表明地址已被接收。
2. 数据：在读数据时，主机会将RREADY信号持续置高，以表明现在可以写数据了。从机会逐个发射数据（RDATA[31:0]），并将RVALID置高以表示数据已有效。发射数据的总数取决于读长度（ARLEN[3:0]）与读尺寸（ARSIZE[2:0]）。当从机发送最后一个读数据后，会将RVALID同时置高以表明数据通信完毕。

读数据分为两种：**突发式读**、**重叠突发式读**。

**突发式读**：当地址出现在地址总线后，传输的数据将出现在读数据通道上。

![clip_image002[6]](https://gitee.com/cxgxgg/typora_img/raw/master/img/202409061428877.jpeg)

**重叠突发式读**：主机传送了两个地址给从机，从机在处理完第一个地址的数据之后，直接才开始处理第二个地址的数据。

![clip_image002[8]](https://gitee.com/cxgxgg/typora_img/raw/master/img/202409061430912.jpeg)

### 乱序传输

AXI协议支持乱序传输。它给每一个通过接口的事务一个IDtag。协议要求相同ID tag的事务必须有序完成，而不同ID tag可以乱序完成。

# AXI_Stream

AXI-Stream总线去掉了地址，允许无限制的数据突发传输规模，AXI4-Stream接口在数据流传输中应用非常方便，主要用于如高速视频、高速 AD 、PCIe、DMA接口等需要**高速数据传输**的场合。我们通常把源端即数据发送的一方称为上游，另一方称为下游。

## 通信模型

本质上AXIS协议也就是握手协议，只不过增加了一个TLAST信号和TSTRB与TKEEP作为指示信号。而TID、TDEST、TUSER等都是用于多级通讯的，AXI-stream基本上是点对点的，这些信号用得很少。

![image-20240906154940398](https://gitee.com/cxgxgg/typora_img/raw/master/img/202409061549439.png)

## 通信信号

| 信号           | 源           | 描述                                                         |
| -------------- | ------------ | ------------------------------------------------------------ |
| ACLK           | Clock source | 总线时钟，上升沿有效                                         |
| ARESETN        | Reset source | 总线复位，低电平有效                                         |
| TVALID         | 主机         | 主机告诉从机数据本次传输有效                                 |
| TDATA[8*n-1:0] | 主机         | 数据，位宽为8的倍数                                          |
| TSTRB[n-1:0]   | 主机         | 每一bit对应TDATA的一个有效字节，用来表示DATA的数据是否有效。宽度为 TDATA/8 |
| TKEEP          | 主机         | 字节传送控制信号，说明总线上的数据是不是有效的               |
| TLAST          | 主机         | 主机告诉从机该次传输为突发传输的结尾                         |
| TID            | 主机         | 数据流标识                                                   |
| TDEST          | 主机         | 为数据流提供路由信息                                         |
| TREADY         | 从机         | 从机告诉主机做好传输准备                                     |
| TUSER          | -            | 用户定义信号，宽度为128bit                                   |

TSTRB和TKEEP作为指示信号，他们的组合指示了当前字节的数据类型

| TKEEP | TSTRB | 数据类型 | 说明                                                         |
| ----- | ----- | -------- | ------------------------------------------------------------ |
| 1     | 1     | Data     | 源和目标之间传输的有效信息的数据字节                         |
| 1     | 0     | Position | 流内部数据字节的相对位置的字节。 这是一个不包含在源和目标之间传输的任何相关数据值的占位符 |
| 0     | 0     | Null     | 不包含任何数据信息的字节或关于流内数据字节的相对位置的任何信息 |
| 0     | 1     | 保留     | -                                                            |

如果发送字节流，可以传输任何数量的数据字节，NULL字节没有含义，可以插入或删除；如果发送连续不对齐流，如数据包只有18B,但是对齐需要20B/24B，可以引入引入占位字节（Position）。位置字节和空字节最大的差别就是他们能不能被删除，这对于对于内存的写入位宽对齐尤为重要。

### 通信时序

从机TREADY置高以等待数据流的到来。当主机将TVALID置高后，数据流开始传输。当数据流发送结束，主机将TLAST置高，表明数据发送结束。

![img](https://gitee.com/cxgxgg/typora_img/raw/master/img/202409061603478.png)

## 反压问题

AXI-Stream总线需要注意数据反压问题：数据流源源不断涌入，但从机处理数据能力有限，导致输入数据量大于输出数据量。

这需要要求主机端能够缓存一部分数据。主机可以通过将TVALID始终置低，以给从机喘息的时间。从机可以通过将TREADY置低以请求喘息。